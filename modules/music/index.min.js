"use strict";function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function _toConsumableArray(t){if(Array.isArray(t)){for(var e=0,a=Array(t.length);e<t.length;e++)a[e]=t[e];return a}return Array.from(t)}function entries(t){var e=[],a=!0,n=!1,i=void 0;try{for(var s,o=Object.keys(t)[Symbol.iterator]();!(a=(s=o.next()).done);a=!0){var r=s.value;e.push([r,t[r]])}}catch(l){n=!0,i=l}finally{try{!a&&o["return"]&&o["return"]()}finally{if(n)throw i}}return e}var _createClass=function(){function t(t,e){for(var a=0;a<e.length;a++){var n=e[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(t,n.key,n)}}return function(e,a,n){return a&&t(e.prototype,a),n&&t(e,n),e}}(),$=function(t){var e=[].concat(_toConsumableArray(document.querySelectorAll(t)));return e.length>1?e:1==e.length?e[0]:[]},getInnerText=function(t){return"string"==typeof t.textContent?t.textContent:t.innerText},setInnerText=function(t,e){"string"==typeof t.textContent?t.textContent=e:t.innerText=e},getIndex=function(t,e){for(var a=0,n=e.length;a<n;a++)if(e[a]==t)return a;return 0},jsonp=function(t,e){var a=document.createElement("script");a.setAttribute("type","text/javascript");var n=e?"?"+entries(e).map(function(t){return t.join("=")}).join("&"):"";a.src=""+t+n,document.body.appendChild(a),setTimeout(function(){a.parentNode.removeChild(a)},2e3)},Audio=function(){function t(){_classCallCheck(this,t),this.audio=document.createElement("audio"),this.audio.src="",this.audio.autoplay=!0,this.audio.loop=!0,document.body.appendChild(this.audio)}return _createClass(t,[{key:"play",value:function(){this.play()}},{key:"pause",value:function(){this.pause()}},{key:"muted",value:function(){this.audio.muted=!0}},{key:"unmuted",value:function(){this.audio.muted=!1}},{key:"volumeUp",value:function(){this.audio.volume=this.audio.volume+.01>=1?1:this.audio.volume+.01}},{key:"volumeDown",value:function(){this.audio.volume=this.audio.volume-.01<=0?0:this.audio.volume-.01}},{key:"setVolume",value:function(t){this.audio.volume=t}},{key:"setSrc",value:function(t){this.audio.src=t}}]),t}(),Player=function(t){function e(t){_classCallCheck(this,e);var a=_possibleConstructorReturn(this,Object.getPrototypeOf(e).call(this));return a.btn={play:$("#play"),next:$("#next"),prev:$("#prev"),volume:$("#volume"),setVolume:$("#setVolume"),volumeValue:$("#volumeValue"),setSrc:$("#setSrc")},a.playInfo={song:$("#play-songName"),time:$("#play-time"),load:$("#play-load"),pro:$("#play-pro"),lrc:$("#lrc"),lrcBottom:$("#lrcBottom"),lrcMove:$("#lrcMove")},a.video=$("#video"),a.list={className:"",count:0},a.init(),a}return _inherits(e,t),_createClass(e,[{key:"init",value:function(){this.audioSet(),this.btnBind(),this.lrc=""}},{key:"setInfo",value:function(t){this.playInfo.song.innerHTML=t}},{key:"setVolumeValue",value:function(t){this.btn.setVolume.value=t||this.audio.volume.toFixed(1),this.btn.volumeValue.value=t||this.audio.volume.toFixed(1)}},{key:"timeTrans",value:function(t){var e=parseInt(t),a=parseInt(e/60);return a=a<10?"0"+a:a,e=60&e,e=e<10?"0"+e:e,a+":"+e}},{key:"resetPlay",value:function(){this.playInfo.pro.style.width=0,this.playInfo.time.innerHTML="00:00 / 00:00",this.lrc="",this.audio.pause(),this.video.pause(),this.playInfo.lrc.innerHTML="",this.playInfo.lrcMove.style.marginTop=0,this.playInfo.lrcBottom.innerHTML=""}},{key:"drawLrc",value:function(){var t="<p>"+this.lrc.map(function(t){return t[1]}).join("</p><p>")+"</p>";this.playInfo.lrcBottom.innerHTML=t,this.playInfo.lrc.innerHTML=t,this.playInfo.lrcMove.style.height=this.playInfo.lrcBottom.style.height}},{key:"audioSet",value:function(){var t=this;this.audio.onended=this.resetPlay,this.audio.onplay=function(){return t.btn.play.classList.add("active")},this.audio.onpause=function(){return t.btn.play.classList.remove("active")},this.audio.ontimeupdate=function(e){var a=t.timeTrans(t.audio.currentTime),n=t.timeTrans(t.audio.duration),i=t.audio.currentTime/t.audio.duration*100+"%";if(t.playInfo.pro.style.width=i,t.playInfo.time.innerHTML=a+" / "+n,t.lrc)for(var s=0,o=t.lrc.length;s<o;s++)if(t.audio.currentTime>t.lrc[s][0]){var r=t.playInfo.lrc.querySelector(".active"),l=t.playInfo.lrc,c=l.childNodes[s];getIndex(r,l.childNodes)<=s&&!c.classList.contains("active")&&(l.querySelector(".active")&&l.querySelector(".active").classList.remove("active"),c.classList.add("active"),t.playInfo.lrcMove.style.marginTop=-60*s+"px")}}}},{key:"btnBind",value:function(){var t=this;this.btn.play.onclick=function(){return t.btn.play.classList.contains("active")?t.audio.pause():t.audio.play()},this.btn.volume.onclick=function(){t.audio.muted?(t.unmuted(),t.btn.volume.setAttribute("data-volume",2)):(t.muted(),t.btn.volume.setAttribute("data-volume",0))},this.btn.setVolume.onchange=function(){var e=t.btn.setVolume.value;t.setVolumeValue(e),t.setVolume(e)},this.btn.setSrc.onchange=function(){t.setSrc(t.btn.setVolume.value)}}}]),e}(Audio),player=new Player,loadData={},Search=function(){function t(){_classCallCheck(this,t),this.list=$("#list"),this.searchText=$("#search"),this.searchBtn=$("#searchSub"),this.showSearch=$("#showSearch"),this.searchBox=$("#searchBox"),this.video=$("#video"),this.bind(),this.data={keywords:"",size:0,pages:0,rows:0,page:0,data:[]}}return _createClass(t,[{key:"bind",value:function(){var t=this;this.showSearch.onclick=function(){return t.searchBox.classList.toggle("active")},this.searchBtn.onclick=function(){t.searchBox.classList.remove("active"),t.searchMusic(t.searchText.value)},this.list.onclick=function(e){var a=e||window.event,n=a.target||a.srcElement,i=n.nodeName.toLowerCase(),s=n.classList,o=n.parentNode,r=o.getAttribute("data-id");if("i"==i){var l=getInnerText(n);t.searchMusic(l),t.searchText.value=l}else if(!o.classList.contains("no")){var c=loadData[r];player.resetPlay(),player.setInfo(c.song_name+"-"+c.singer_name),s.contains("mv")?(list.showBox("mv"),player.audio.pause(),t.video.src=c.mv_list[c.mv_list.length-1].url,t.video.play()):(player.setSrc(s.contains("sq")?c.ll_list[0].url:c.url_list[c.url_list.length-1].url),t.searchLrc(r,c.song_name,c.singer_name),t.video.src="",player.audio.play())}},this.list.onscroll=function(){t.list.scrollTop+t.list.offsetHeight>=t.list.scrollHeight&&t.data.page<t.data.pages&&t.searchMusic(t.data.keywords,t.data.page+1,t.data.size,!0)},document.body.onkeyup=function(e){var a=e||window.event,n=a.keyCode||a.keyWhich;if(13==n)if(t.searchBox.classList.contains("active")){if(!t.searchText.value||t.searchText.value==t.data.keywords)return void t.searchBox.classList.remove("active");t.searchBox.classList.remove("active"),t.searchMusic(t.searchText.value)}else t.searchBox.classList.add("active"),t.searchText.select();else 32==n&&(t.searchBox.classList.contains("active")||(t.searchBox.classList.remove("active"),t.searchMusic(t.searchText.value)))}}},{key:"searchMusic",value:function(t,e,a,n){var i=this;list.tips("搜索："+t);var s=e||1,o=a||200,r=n||!1;window.callbackSearchMusic=function(e){i.data.pages=e.pages,i.data.keywords=t,i.data.size=o,i.data.rows=e.rows,i.data.page=s,i.data.data=e.data,list.tips("loading..."),i.drawData(r)},jsonp("http://search.dongting.com/song/search/old",{q:t,page:s,size:o,time:(new Date).getTime(),callback:"callbackSearchMusic"})}},{key:"drawData",value:function(t){t||(loadData={});var e=this.data.data.map(function(t){loadData[t.song_id]=t;var e=t.out_list?" no":"",a=t.ll_list?" hasSQ":"",n=t.mv_list?" hasMV":"",i=t.singer_name?"<i>"+t.singer_name+"</i>":"",s=t.album_name?"<i>"+t.album_name+"</i>":"",o=("<li data-id='"+t.song_id+"' class='"+e+a+n+"'>\n\t\t\t<span class='song'>"+t.song_name+"</span>\n\t\t\t<span class='info'>"+(i+s)+"</span>\n\t\t\t<span class='sq'>SQ</span>\n\t\t\t<span class='mv'>MV</span>\n\t\t\t</li>").trim();return o});t?this.list.innerHTML+=e:this.list.innerHTML=e}},{key:"searchLrc",value:function(t,e,a){var n=this;window.callbackSearchLrc=function(t){1!==t.code?player.playInfo.lrc.innerHTML="<p class='active'>没有找到对应的歌词！</p>":n.parseLyric(t.data.lrc)},jsonp("http://lp.music.ttpod.com/lrc/down",{song_id:t,title:e,artist:a,callback:"callbackSearchLrc"})}},{key:"parseLyric",value:function(t){var e=t.split("\n"),a=/\[\d{2}:\d{2}.\d{2,3}\]/g,n=[];e.filter(function(t){return a.test(t)}),0===e[e.length-1].length&&e.pop(),e.forEach(function(t){var e=t.match(a),i=t.replace(a,"");return e?void e.forEach(function(t){var e=t.slice(1,-1).split(":");n.push([60*parseInt(e[0],10)+parseFloat(e[1]),i])}):(player.playInfo.lrc.innerHTML="<p class='active'>歌词解析出错!</p>",!1)}),player.lrc=n.sort(function(t,e){return t[0]-e[0]}),player.drawLrc()}}]),t}(),List=function(){function t(){_classCallCheck(this,t),this.loadWord="loading...",this.loadEndsWord="loadingEnd",this.panelBtn=$(".panelBtn"),this.tip=$("#tips"),this.ajaxUrl={pub:"http://www.dongting.com/ajax/v1.ard.tj.itlily.com/ttpod?id=281&page=1&size=100","class":"http://fm.api.ttpod.com/taglist?image_type=240_200",singer:"http://www.dongting.com/ajax/v1.ard.tj.itlily.com/ttpod?id=46"},this.listLoading={singer:!1,pub:!1,"class":!1},this.bind()}return _createClass(t,[{key:"tips",value:function(t){var e=this;this.tip.innerHTML=t,this.tip.classList.add("active"),setTimeout(function(){return e.tip.classList.remove("active")},500)}},{key:"loading",value:function(e){var a=e?"Loading Start："+e:t.loadWord;$("#loading span").innerHTML=a,$("#loading").classList.add("active"),setTimeout(function(){return $("#loading").classList.remove("active")},500)}},{key:"loadingEnd",value:function(t){var e=t?"Loading Start："+t:this.loadWord;$("#loading span").innerHTML=e,setTimeout(function(){return $("#loading").classList.remove("active")},1500)}},{key:"bind",value:function(){var t=this;this.panelBtn.forEach(function(e){e.onclick=function(){var a=e.getAttribute("data-type");t.showBox(a),"lrc"!==a&&($("."+a+"Box ul li").length<=0?t.ajaxList(a):$("."+a+"Box").classList.remove("status2"))}}),$(".to-status1").forEach(function(t){t.onclick=function(){t.parentNode.classList.remove("status2")}}),$(".box2").forEach(function(t){t.onclick=function(t){var e=t||window.event,a=e.target||e.srcElement,n=a.classList;return!!(n.contains("song")||n.contains("singer")||n.contains("album"))&&void search.searchMusic(getInnerText(a))}}),$(".pubBox .box1").onclick=function(e){var a=e||window.event,n=a.target||a.srcElement,i=n.nodeName.toLowerCase();if("li"==i){var s="http://www.dongting.com/ajax/v1.ard.tj.itlily.com/ttpod?id="+n.getAttribute("data-id"),o=getInnerText(n.querySelector("h4"));t.loading(o),window.callbackPubBoxList=function(e){var a=$(".pubBox .box2");a.innerHTML=e.data.map(function(t){return'<li data-id="'+t.song_id+'"><span class="song">'+t.song_name+'</span><span class="singer">'+t.singer_name+'</span><span class="album">'+t.album_name+"</span></li>"}).join(""),a.parentNode.classList.remove("status3"),a.parentNode.classList.add("status2"),t.loadingEnd()},jsonp(s+"&callback=callbackPubBoxList")}},$(".classBox .box1").onclick=function(e){var a=e||window.event,n=a.target||a.srcElement,i=n.nodeName.toLowerCase();if("li"==i){var s="http://fm.api.ttpod.com/songlist?tagid="+n.getAttribute("data-id")+"&size=300",o=getInnerText(n.querySelector("h4"));t.loading(o),window.callbackClassBoxList=function(e){var a=$(".classBox .box2");a.innerHTML=e.data.map(function(t){if(t.songName)return'<li data-id="'+t.neid+'"><span class="song">'+t.songName+'</span><span class="singer">'+(t.singerName||"")+'</span><span class="album">'+(t.albumName||"")+"</span></li>"}).join(""),a.parentNode.classList.remove("status3"),a.parentNode.classList.add("status2"),t.loadingEnd()},jsonp(s+"&callback=callbackClassBoxList")}},$(".singerBox .box1").onclick=function(e){var a=e||window.event,n=a.target||a.srcElement,i=n.nodeName.toLowerCase();if("li"==i){var s="http://www.dongting.com/ajax/v1.ard.tj.itlily.com/ttpod?id="+n.getAttribute("data-id")+"&size=400",o=getInnerText(n.querySelector("h4"));t.loading(o),window.callbackClassBoxList=function(e){var a=$(".singerBox .box2");a.innerHTML=e.data.map(function(t){if(t.songName)return'<li data-id="'+t.singer_id+'"><span class="singer">'+t.singer_name+'</span><img src="'+t.pic_url+'"></li>'}).join(""),a.parentNode.classList.remove("status3"),a.parentNode.classList.add("status2"),t.loadingEnd()},jsonp(s+"&callback=callbackClassBoxList")}}}},{key:"showBox",value:function(t){$(".panel").forEach(function(t){t.classList.contains("active")&&t.classList.remove("active")}),$("."+t+"Box").classList.add("active")}},{key:"ajaxList",value:function(t){var e=this;this.listLoading[t]||"mv"===t||(this.listLoading[t]=!0,window["callbackGetTypeOf"+t]=function(a){e.drawList(a.data,t)},jsonp(this.ajaxUrl[t]+"&callback=callbackGetTypeOf"+t))}},{key:"drawList",value:function(t,e){switch(e){case"pub":$("."+e+"Box .box1").innerHTML=t.map(function(t){return'<li data-id="'+t.id+'"><img src="'+t.big_pic_url+'"><h4>'+t.title+"</h4></li>"}).join("");break;case"class":$("."+e+"Box .box1").innerHTML=t.map(function(t){return'<li data-id="'+t.id+'"><img src="'+t.pic_url_240_200+'"><h4>'+t.title+"</h4></li>"}).join("");break;case"singer":$("."+e+"Box .box1").innerHTML=t.map(function(t){return'<li data-id="'+t.id+'"><img src="'+t.pic_url+'"><h4>'+t.title+"</h4></li>"}).join("")}}}]),t}(),search=new Search,list=new List;